name: Auto Trade Bot

on:
  workflow_dispatch:   # bisa dijalankan manual
  schedule:
    - cron: "*/1 * * * *"  # setiap 1 menit UTC → cek M30 WIB (UTC+7)

concurrency:
  group: auto-trade-bot
  cancel-in-progress: true

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests

      - name: Run bot
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          API_KEY: ${{ secrets.API_KEY }}
          PASTEBIN_API_DEV_KEY: ${{ secrets.PASTEBIN_API_DEV_KEY }}
          PASTEBIN_USERNAME: ${{ secrets.PASTEBIN_USERNAME }}
          PASTEBIN_PASSWORD: ${{ secrets.PASTEBIN_PASSWORD }}
          PASTEBIN_RAW_URL: ${{ secrets.PASTEBIN_RAW_URL }}
          PAIR_LIST: ${{ secrets.PAIR_LIST }}
          MIN_CONFIDENCE: ${{ secrets.MIN_CONFIDENCE }}
          DEBUG_MODE: ${{ secrets.DEBUG_MODE }}
        run: |
          echo "Checking market & DZ signals..."
          python - <<'EOF'
import bot
from datetime import datetime, timezone, timedelta

# Timezone WIB
WIB = timezone(timedelta(hours=7))
def now_wib():
    return datetime.now(timezone.utc).astimezone(WIB)

t = now_wib().strftime("%Y-%m-%d %H:%M")
print(f"⏱ Checking at {t} WIB")

# Hanya jalankan analisis jika candle M30 close
if bot.valid_m30_time():
    print("✅ M30 close detected, running analysis...")
    for pair in bot.PAIR_LIST:
        result = bot.analyze(pair)
        if not result:
            continue
        action, confidence, reason, state, tp, sl = result
        dz_signal = None
        # Hitung DZ untuk debug
        df = bot.get_market_data(pair)
        if df is not None:
            last_price = df['close'].iloc[-1]
            recent_low = df['low'].iloc[-20:].min()
            recent_high = df['high'].iloc[-20:].max()
            if last_price <= recent_low * 1.002:
                dz_signal = "BUY"
            elif last_price >= recent_high * 0.998:
                dz_signal = "SELL"

        msg = (
            f"PAIR: {pair}\n"
            f"TF: 30M\n"
            f"SIGNAL: {action}\n"
            f"CONFIDENCE: {confidence}% (min {bot.MIN_CONFIDENCE}%)\n"
            f"STATE: {state}\n"
            f"REASON:\n- " + "\n- ".join(reason)
        )
        if tp and sl:
            msg += f"\nTP: {tp:.5f}\nSL: {sl:.5f}\nHOLD: 30–120 menit"
        if dz_signal:
            msg += f"\nDZ SIGNAL: {dz_signal}"
        msg += f"\nTIME: {t} WIB"
        print(msg)
else:
    print("⏳ Not M30 close yet, skipping analysis.")
EOF
